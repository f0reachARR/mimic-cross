#!/host/bin/bash -e

if [ "$1" = 'install' -o "$1" = 'upgrade' ]; then
    package_list=$(mktemp)
    /usr/bin/apt-get install cmake --dry-run | grep Inst | cut -d ' ' -f 2 \
        | sed -e "s/^gcc\(-[0-9]\+\)\?$/gcc\1-$(arch)-linux-gnu/" \
        | sort -u > $package_list
    supported_packages=$(comm -12 "$MIMIC_CROSS_ROOT"/supported_packages.list "$package_list")
    rm "$package_list"
fi

/usr/bin/apt-get $@

if [ ! "${supported_packages+exist}" ]; then
    exit 0
fi

chroot /host apt-get install $supported_packages
for package in $supported_packages; do
    $MIMIC_CROSS_ROOT/postinst/$package.sh
done
