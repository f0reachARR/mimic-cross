#!/host/bin/bash -e

source $MIMIC_CROSS_ROOT/script/replace_package_name.sh

ts=$(date "+%Y-%m-%d %H:%M:%S")
/usr/bin/apt-get $@
package_list=$(mktemp)
awk -F[-:\ ] -v ts="$ts" 'ts<$0 && $8=="installed"' /var/log/dpkg.log | awk -F[:\ ] '{print $7}' \
    | replace_package_name > $package_list
supported_packages=$(comm -12 "$MIMIC_CROSS_ROOT"/supported_packages.list "$package_list")
rm "$package_list"

if [[ ! "${supported_packages}" ]]; then 
    exit 0
fi

mv /host/etc/resolv.conf /host/etc/resolv.conf.orig
cp /etc/resolv.conf /host/etc/resolv.conf
/host/$(which chroot) /host apt-get install $supported_packages
mv /host/etc/resolv.conf.orig /host/etc/resolv.conf
for package in $supported_packages; do
    . $MIMIC_CROSS_ROOT/postinst/$package.sh
done
