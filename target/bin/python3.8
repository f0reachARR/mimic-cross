#!/bin/bash -e

VERSIONED_PYTHON=$(realpath $0 | xargs basename)

mimic-python() {
    PREFIXED_PYTHONPATH=''
    for path in $(echo $PYTHONPATH | sed "s/:/ /g"); do
        PREFIXED_PYTHONPATH+=/host$path:
    done
    PREFIXED_LD_LIBRARY_PATH=''
    for path in $(echo $LD_LIBRARY_PATH | sed "s/:/ /g"); do
        PREFIXED_LD_LIBRARY_PATH+=/host$path:
    done
    PREFIXED_VIRTUAL_ENV=/host$VIRTUAL_ENV
    (LD_LIBRARY_PATH=$PREFIXED_LD_LIBRARY_PATH:$LD_LIBRARY_PATH PYTHONPATH=$PREFIXED_PYTHONPATH:/host/usr/lib/$VERSIONED_PYTHON:/host/usr/lib/$VERSIONED_PYTHON/lib-dynload:/host/usr/local/lib/$VERSIONED_PYTHON/dist-packages:/host/usr/lib/python3/dist-packages:$PYTHONPATH exec -a "$0" /host/usr/bin/"$VERSIONED_PYTHON" "$@")
}

# call pip module
echo "$@" | grep -P "(^| )-m pip\b" > /dev/null &&  {
    pip_log=$(mktemp)
    mimic-python "$@" --log-file "$pip_log"
    cp /etc/resolv.conf /host/etc
    cat "$pip_log" | awk '$2=="Added" && '/aarch64.whl/' {print($3)}' | sort -u | xargs -r chroot /host $VERSIONED_PYTHON -m pip install
    cp /host/etc/resolv.conf.orig /host/etc/resolv.conf
    rm $pip_log
    exit 0
}

# call venv module
echo "$@" | grep -P "(^| )-m venv\b" > /dev/null &&  {
    mimic-python "$@"
    cp /etc/resolv.conf /host/etc
    chroot /host $VERSIONED_PYTHON "$@"
    cp /host/etc/resolv.conf.orig /host/etc/resolv.conf
    exit 0
}

if [[ ${DISABLE_MIMIC_PYTHONPATH:exist} ]]; then
    (exec -a "$0" /host/usr/bin/"$VERSIONED_PYTHON" "$@")
else
    mimic-python "$@"
fi
