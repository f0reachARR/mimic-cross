#!/bin/bash -e

mimic-python() {
    PREFIXED_PYTHONPATH=''
    for path in $(echo $PYTHONPATH | sed "s/:/ /g"); do
        PREFIXED_PYTHONPATH+=/host$path:
    done
    PREFIXED_LD_LIBRARY_PATH=''
    for path in $(echo $LD_LIBRARY_PATH | sed "s/:/ /g"); do
        PREFIXED_LD_LIBRARY_PATH+=/host$path:
    done
    (LD_LIBRARY_PATH=$PREFIXED_LD_LIBRARY_PATH:$LD_LIBRARY_PATH PYTHONPATH=$PREFIXED_PYTHONPATH:/host/usr/lib/python3.8:/host/usr/lib/python3.8/lib-dynload:/host/usr/local/lib/python3.8/dist-packages:/host/usr/lib/python3/dist-packages:$PYTHONPATH exec -a '/usr/bin/python3.8' /host/usr/bin/python3.8 "$@")
}

# call pip module
echo "$@" | grep -P "(^| )-m pip\b" > /dev/null &&  {
    pip_log=$(mktemp)
    mimic-python "$@" --log-file "$pip_log"
    cp /etc/resolv.conf /host/etc
    cat "$pip_log" | awk '$2=="Added" && '/aarch64.whl/' {print($3)}' | sort -u | xargs -r chroot /host python3.8 -m pip install
    cp /host/etc/resolv.conf.orig /host/etc/resolv.conf
    rm $pip_log
    exit 0
}

if [[ ${DISABLE_MIMIC_PYTHONPATH:exist} ]]; then
    (exec -a '/usr/bin/python3.8' /host/usr/bin/python3.8 "$@")
else
    mimic-python "$@"
fi
